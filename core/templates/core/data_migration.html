{% extends 'base.html' %}
{% load static %}

{% block title %}Migration de données - {{ system_settings.company_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-content">
        <div>
            <h1>Migration de données</h1>
            <p class="text-secondary">Importer les données de l'ancien système en collant les valeurs SQL VALUES</p>
        </div>
        <a href="{% url 'settings' %}" class="btn btn-secondary btn-sm">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Retour
        </a>
    </div>
</div>

<!-- Messages -->
{% if messages %}
<div class="messages-container">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Résultats de migration -->
{% if migration_stats %}
<div class="card" style="margin-bottom: 20px; border-left: 4px solid var(--success-color, #28a745);">
    <div class="card-header">
        <h3 class="card-title">Résultat de la migration</h3>
    </div>
    <div class="card-body">
        <div class="form-grid" style="grid-template-columns: repeat(3, 1fr); gap: 12px;">
            <div><strong>Catégories créées :</strong> {{ migration_stats.categories }}</div>
            <div><strong>Gammes créées :</strong> {{ migration_stats.gammes }}</div>
            <div><strong>Rayons créés :</strong> {{ migration_stats.rayons }}</div>
            <div><strong>Types grammage créés :</strong> {{ migration_stats.grammage_types }}</div>
            <div><strong>Produits créés :</strong> {{ migration_stats.products }}</div>
            <div><strong>Images importées :</strong> {{ migration_stats.images }}</div>
        </div>
        {% if migration_stats.errors %}
        <div style="margin-top: 16px;">
            <strong>Avertissements ({{ migration_stats.errors|length }}) :</strong>
            <ul style="margin-top: 8px; font-size: 13px; max-height: 200px; overflow-y: auto; background: var(--bg-secondary, #f5f5f5); padding: 12px 12px 12px 30px; border-radius: 6px;">
                {% for error in migration_stats.errors %}
                <li style="margin-bottom: 4px;">{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Formulaire de migration -->
<form method="post" action="{% url 'data_migration' %}">
    {% csrf_token %}

    {% if form.non_field_errors %}
    <div class="form-errors" style="margin-bottom: 16px;">
        {% for error in form.non_field_errors %}
        <div class="alert alert-error">{{ error }}</div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="card" style="margin-bottom: 16px;">
        <div class="card-header">
            <h3 class="card-title">1. Données de référence (à remplir en premier)</h3>
        </div>
        <div class="card-body">
            <p class="text-secondary" style="margin-bottom: 16px; font-size: 13px;">
                Collez les données SQL VALUES des tables de référence. Ces données seront utilisées pour mapper les relations des produits.
            </p>
            <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="form-group">
                    <label class="form-label">{{ form.categories_sql.label }}</label>
                    {{ form.categories_sql }}
                    <small class="text-secondary">{{ form.categories_sql.help_text }}</small>
                    {% if form.categories_sql.errors %}<div class="field-error">{{ form.categories_sql.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label class="form-label">{{ form.gammes_sql.label }}</label>
                    {{ form.gammes_sql }}
                    <small class="text-secondary">{{ form.gammes_sql.help_text }}</small>
                    {% if form.gammes_sql.errors %}<div class="field-error">{{ form.gammes_sql.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label class="form-label">{{ form.rayons_sql.label }}</label>
                    {{ form.rayons_sql }}
                    <small class="text-secondary">{{ form.rayons_sql.help_text }}</small>
                    {% if form.rayons_sql.errors %}<div class="field-error">{{ form.rayons_sql.errors.0 }}</div>{% endif %}
                </div>
                <div class="form-group">
                    <label class="form-label">{{ form.grammage_types_sql.label }}</label>
                    {{ form.grammage_types_sql }}
                    <small class="text-secondary">{{ form.grammage_types_sql.help_text }}</small>
                    {% if form.grammage_types_sql.errors %}<div class="field-error">{{ form.grammage_types_sql.errors.0 }}</div>{% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="card" style="margin-bottom: 16px;">
        <div class="card-header">
            <h3 class="card-title">2. Produits</h3>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label class="form-label">{{ form.products_sql.label }}</label>
                {{ form.products_sql }}
                <small class="text-secondary">{{ form.products_sql.help_text }}</small>
                {% if form.products_sql.errors %}<div class="field-error">{{ form.products_sql.errors.0 }}</div>{% endif %}
            </div>
        </div>
    </div>

    <div class="card" style="margin-bottom: 16px;">
        <div class="card-header">
            <h3 class="card-title">3. Images des produits</h3>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label class="form-label">{{ form.images_sql.label }}</label>
                {{ form.images_sql }}
                <small class="text-secondary">{{ form.images_sql.help_text }}</small>
                {% if form.images_sql.errors %}<div class="field-error">{{ form.images_sql.errors.0 }}</div>{% endif %}
            </div>
        </div>
    </div>

    <div class="form-actions" style="margin-bottom: 32px;">
        <button type="submit" class="btn btn-primary" onclick="return confirm('Êtes-vous sûr de vouloir lancer la migration ? Cette action va créer les données dans le système.')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Lancer la migration
        </button>
        <a href="{% url 'settings' %}" class="btn btn-secondary">Annuler</a>
    </div>
</form>
{% endblock %}

