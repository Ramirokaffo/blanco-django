{% extends 'base.html' %}
{% load static %}

{% block title %}Dépenses/Recettes - {{ system_settings.company_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/expenses.css' %}">
<style>
.tabs-container {
    display: flex;
    border-bottom: 2px solid var(--border-color);
    margin-bottom: 20px;
}
.tab-btn {
    padding: 12px 24px;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    color: var(--text-secondary);
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
}
.tab-btn:hover {
    color: var(--text-primary);
}
.tab-btn.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
}
.tab-content {
    display: none;
}
.tab-content.active {
    display: block;
}
.tab-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}
.tab-stats {
    font-size: 14px;
    color: var(--text-secondary);
}
.expense-amount {
    color: var(--danger-color);
}
.recipe-amount {
    color: var(--success-color);
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-content">
        <div>
            <h1>Dépenses / Recettes</h1>
            <p class="text-secondary">Gestion des opérations quotidiennes</p>
        </div>
    </div>
</div>

<!-- Messages -->
{% if messages %}
<div class="messages-container">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Onglets -->
<div class="tabs-container">
    <button class="tab-btn {% if active_tab == 'expenses' %}active{% endif %}" onclick="switchTab('expenses')">
        Dépenses ({{ expenses_count }})
    </button>
    <button class="tab-btn {% if active_tab == 'recipes' %}active{% endif %}" onclick="switchTab('recipes')">
        Recettes ({{ recipes_count }})
    </button>
</div>

<!-- Contenu Onglet Dépenses -->
<div id="expenses-tab" class="tab-content {% if active_tab == 'expenses' or not active_tab %}active{% endif %}">
    <div class="tab-header">
        <a href="{% url 'add_expense' %}" class="btn btn-primary btn-sm">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Nouvelle dépense
        </a>
        <span class="tab-stats">Total: <strong class="expense-amount">{{ total_expenses|floatformat:0 }} FCFA</strong></span>
    </div>

    <!-- Filtres Dépenses -->
    <div class="card filters-card">
        <form method="get" action="{% url 'expenses' %}" class="filters-form" id="expensesForm">
            <input type="hidden" name="tab" value="expenses">
            <div class="filters-row">
                <div class="filter-group filter-search">
                    <label class="form-label">Recherche</label>
                    <input type="text" name="search" class="form-control" placeholder="Description ou type..." value="{{ current_search }}">
                </div>
                <div class="filter-group">
                    <label class="form-label">Type</label>
                    <select name="expense_type" class="form-control">
                        <option value="">Tous</option>
                        {% for et in expense_types %}
                        <option value="{{ et.id }}" {% if current_expense_type == et.id|stringformat:"d" %}selected{% endif %}>{{ et.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label class="form-label">Date début</label>
                    <input type="date" name="date_from" class="form-control" value="{{ current_date_from }}">
                </div>
                <div class="filter-group">
                    <label class="form-label">Date fin</label>
                    <input type="date" name="date_to" class="form-control" value="{{ current_date_to }}">
                </div>
            </div>
            <div class="filters-actions">
                <button type="submit" class="btn btn-primary btn-sm">Filtrer</button>
                <a href="{% url 'expenses' %}?tab=expenses" class="btn btn-secondary btn-sm">Réinitialiser</a>
            </div>
        </form>
    </div>

    <!-- Tableau Dépenses -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table expenses-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Compte</th>
                            <th>Montant</th>
                            <th>Personnel</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for expense in expenses %}
                        <tr>
                            <td>{{ expense.create_at|date:"d/m/Y H:i" }}</td>
                            <td>{{ expense.expense_type.name|default:"-" }}</td>
                            <td>{{ expense.description|default:"-"|truncatewords:12 }}</td>
                            <td>{{ expense.account.code|default:"65" }}</td>
                            <td class="text-right expense-amount">{{ expense.amount|floatformat:0 }} FCA</td>
                            <td>{{ expense.staff.get_full_name|default:"-" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center">Aucune dépense trouvée</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if expenses_page.paginator.num_pages > 1 %}
            <div class="pagination-container">
                <div class="pagination-info">
                    Affichage de {{ expenses_page.start_index }} à {{ expenses_page.end_index }} sur {{ expenses_count }}
                </div>
                <div class="pagination">
                    {% if expenses_page.has_previous %}
                    <a href="?tab=expenses&page=1" class="pagination-btn">&laquo;</a>
                    <a href="?tab=expenses&page={{ expenses_page.previous_page_number }}" class="pagination-btn">&lsaquo;</a>
                    {% endif %}
                    {% for num in expenses_page.paginator.page_range %}
                        {% if expenses_page.number == num %}
                        <span class="pagination-btn active">{{ num }}</span>
                        {% elif num > expenses_page.number|add:'-3' and num < expenses_page.number|add:'3' %}
                        <a href="?tab=expenses&page={{ num }}" class="pagination-btn">{{ num }}</a>
                        {% endif %}
                    {% endfor %}
                    {% if expenses_page.has_next %}
                    <a href="?tab=expenses&page={{ expenses_page.next_page_number }}" class="pagination-btn">&rsaquo;</a>
                    <a href="?tab=expenses&page={{ expenses_page.paginator.num_pages }}" class="pagination-btn">&raquo;</a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Contenu Onglet Recettes -->
<div id="recipes-tab" class="tab-content {% if active_tab == 'recipes' %}active{% endif %}">
    <div class="tab-header">
        <a href="{% url 'add_recipe' %}" class="btn btn-success btn-sm">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Nouvelle recette
        </a>
        <span class="tab-stats">Total: <strong class="recipe-amount">{{ total_recipes|floatformat:0 }} FCA</strong></span>
    </div>

    <!-- Filtres Recettes -->
    <div class="card filters-card">
        <form method="get" action="{% url 'expenses' %}" class="filters-form" id="recipesForm">
            <input type="hidden" name="tab" value="recipes">
            <div class="filters-row">
                <div class="filter-group filter-search">
                    <label class="form-label">Recherche</label>
                    <input type="text" name="search" class="form-control" placeholder="Description ou type..." value="{{ current_search }}">
                </div>
                <div class="filter-group">
                    <label class="form-label">Type</label>
                    <select name="recipe_type" class="form-control">
                        <option value="">Tous</option>
                        {% for rt in recipe_types %}
                        <option value="{{ rt.id }}" {% if current_recipe_type == rt.id|stringformat:"d" %}selected{% endif %}>{{ rt.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label class="form-label">Date début</label>
                    <input type="date" name="date_from" class="form-control" value="{{ current_date_from }}">
                </div>
                <div class="filter-group">
                    <label class="form-label">Date fin</label>
                    <input type="date" name="date_to" class="form-control" value="{{ current_date_to }}">
                </div>
            </div>
            <div class="filters-actions">
                <button type="submit" class="btn btn-primary btn-sm">Filtrer</button>
                <a href="{% url 'expenses' %}?tab=recipes" class="btn btn-secondary btn-sm">Réinitialiser</a>
            </div>
        </form>
    </div>

    <!-- Tableau Recettes -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table expenses-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Compte</th>
                            <th>Montant</th>
                            <th>Personnel</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for recipe in recipes %}
                        <tr>
                            <td>{{ recipe.create_at|date:"d/m/Y H:i" }}</td>
                            <td>{{ recipe.recipe_type.name|default:"-" }}</td>
                            <td>{{ recipe.description|default:"-"|truncatewords:12 }}</td>
                            <td>{{ recipe.account.code|default:"75" }}</td>
                            <td class="text-right recipe-amount">{{ recipe.amount|floatformat:0 }} FCA</td>
                            <td>{{ recipe.staff.get_full_name|default:"-" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center">Aucune recette trouvée</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if recipes_page.paginator.num_pages > 1 %}
            <div class="pagination-container">
                <div class="pagination-info">
                    Affichage de {{ recipes_page.start_index }} à {{ recipes_page.end_index }} sur {{ recipes_count }}
                </div>
                <div class="pagination">
                    {% if recipes_page.has_previous %}
                    <a href="?tab=recipes&page=1" class="pagination-btn">&laquo;</a>
                    <a href="?tab=recipes&page={{ recipes_page.previous_page_number }}" class="pagination-btn">&lsaquo;</a>
                    {% endif %}
                    {% for num in recipes_page.paginator.page_range %}
                        {% if recipes_page.number == num %}
                        <span class="pagination-btn active">{{ num }}</span>
                        {% elif num > recipes_page.number|add:'-3' and num < recipes_page.number|add:'3' %}
                        <a href="?tab=recipes&page={{ num }}" class="pagination-btn">{{ num }}</a>
                        {% endif %}
                    {% endfor %}
                    {% if recipes_page.has_next %}
                    <a href="?tab=recipes&page={{ recipes_page.next_page_number }}" class="pagination-btn">&rsaquo;</a>
                    <a href="?tab=recipes&page={{ recipes_page.paginator.num_pages }}" class="pagination-btn">&raquo;</a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function switchTab(tabName) {
    // Mettre à jour l'URL sans recharger
    const url = new URL(window.location);
    url.searchParams.set('tab', tabName);
    window.location.href = url.toString();
}
</script>
{% endblock %}
