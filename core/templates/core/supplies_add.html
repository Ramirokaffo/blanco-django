{% extends 'base.html' %}
{% load static %}

{% block title %}Nouvel approvisionnement - {{ system_settings.company_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/supplies.css' %}">
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-content">
        <div>
            <h1>Nouvel approvisionnement</h1>
            <p class="text-secondary">Enregistrer un nouvel approvisionnement de stock</p>
        </div>
        <a href="{% url 'supplies' %}" class="btn btn-secondary btn-sm">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Retour à la liste
        </a>
    </div>
</div>

<!-- Messages -->
{% if messages %}
<div class="messages-container">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Formulaire -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Informations de l'approvisionnement</h3>
    </div>
    <div class="card-body">
        <form method="post" action="{% url 'add_supply' %}" class="supply-form" id="supplyForm">
            {% csrf_token %}

            {% if form.non_field_errors %}
            <div class="form-errors">
                {% for error in form.non_field_errors %}
                <div class="alert alert-error">{{ error }}</div>
                {% endfor %}
            </div>
            {% endif %}

            <div class="form-grid">
                <!-- Produit -->
                <div class="form-group">
                    <label class="form-label" for="id_product">{{ form.product.label }} <span class="required">*</span></label>
                    {{ form.product }}
                    {% if form.product.errors %}
                    <div class="field-error">{{ form.product.errors.0 }}</div>
                    {% endif %}
                </div>

                <!-- Fournisseur -->
                <div class="form-group">
                    <label class="form-label" for="id_supplier">{{ form.supplier.label }}</label>
                    {{ form.supplier }}
                    {% if form.supplier.errors %}
                    <div class="field-error">{{ form.supplier.errors.0 }}</div>
                    {% endif %}
                </div>

                <!-- Quantité -->
                <div class="form-group">
                    <label class="form-label" for="id_quantity">{{ form.quantity.label }} <span class="required">*</span></label>
                    {{ form.quantity }}
                    {% if form.quantity.errors %}
                    <div class="field-error">{{ form.quantity.errors.0 }}</div>
                    {% endif %}
                </div>

                <!-- Prix d'achat unitaire -->
                <div class="form-group">
                    <label class="form-label" for="id_unit_price">{{ form.purchase_cost.label }} <span class="required">*</span></label>
                    {{ form.purchase_cost }}
                    {% if form.purchase_cost.errors %}
                    <div class="field-error">{{ form.purchase_cost.errors.0 }}</div>
                    {% endif %}
                </div>

                <!-- Prix de vente -->
                <div class="form-group">
                    <label class="form-label" for="id_selling_price">{{ form.selling_price.label }}</label>
                    {{ form.selling_price }}
                    {% if form.selling_price.errors %}
                    <div class="field-error">{{ form.selling_price.errors.0 }}</div>
                    {% endif %}
                </div>

                <!-- Date d'expiration -->
                <div class="form-group">
                    <label class="form-label" for="id_expiration_date">{{ form.expiration_date.label }}</label>
                    {{ form.expiration_date }}
                    {% if form.expiration_date.errors %}
                    <div class="field-error">{{ form.expiration_date.errors.0 }}</div>
                    {% endif %}
                </div>

                <!-- Mode de paiement -->
                <div class="form-group">
                    <label class="form-label" for="id_payment_method">{{ form.payment_method.label }}</label>
                    {{ form.payment_method }}
                    {% if form.payment_method.errors %}
                    <div class="field-error">{{ form.payment_method.errors.0 }}</div>
                    {% endif %}
                </div>

                <!-- Achat à crédit -->
                <div class="form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                    {{ form.is_credit }}
                    <label class="form-label" for="id_is_credit" style="margin: 0;">{{ form.is_credit.label }}</label>
                    {% if form.is_credit.errors %}
                    <div class="field-error">{{ form.is_credit.errors.0 }}</div>
                    {% endif %}
                </div>

                <!-- Taux de TVA -->
                <div class="form-group" id="taxRateGroup" style="display:none;">
                    <label class="form-label" for="id_tax_rate">{{ form.tax_rate.label }}</label>
                    {{ form.tax_rate }}
                    {% if form.tax_rate.errors %}
                    <div class="field-error">{{ form.tax_rate.errors.0 }}</div>
                    {% endif %}
                </div>

                <!-- Type de dépense -->
                <div class="form-group">
                    <label class="form-label" for="id_expense_type">{{ form.expense_type.label }} <span class="required">*</span></label>
                    {{ form.expense_type }}
                    {% if form.expense_type.errors %}
                    <div class="field-error">{{ form.expense_type.errors.0 }}</div>
                    {% endif %}
                    <small class="form-help">{{ form.expense_type.help_text }}</small>
                </div>
            </div>

            <!-- Récapitulatif -->
            <div class="supply-summary" id="supplySummary" style="display:none;">
                <h4>Récapitulatif</h4>
                <div class="summary-row">
                    <span>Coût total :</span>
                    <strong id="totalCost">0 FCFA</strong>
                </div>
                <div class="summary-row" id="vatRow" style="display:none;">
                    <span>TVA :</span>
                    <strong id="vatAmount">0 FCFA</strong>
                </div>
                <div class="summary-row" id="totalWithVatRow" style="display:none;">
                    <span>Total TTC :</span>
                    <strong id="totalWithVat">0 FCFA</strong>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    Enregistrer l'approvisionnement
                </button>
                <a href="{% url 'supplies' %}" class="btn btn-secondary">Annuler</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const qtyInput = document.getElementById('id_quantity');
    const priceInput = document.getElementById('id_unit_price');
    const taxRateSelect = document.getElementById('id_tax_rate');
    const taxRateGroup = document.getElementById('taxRateGroup');
    const expenseTypeSelect = document.getElementById('id_expense_type');
    const summary = document.getElementById('supplySummary');
    const totalCost = document.getElementById('totalCost');
    const vatRow = document.getElementById('vatRow');
    const vatAmount = document.getElementById('vatAmount');
    const totalWithVatRow = document.getElementById('totalWithVatRow');
    const totalWithVat = document.getElementById('totalWithVat');
    const supplyForm = document.getElementById('supplyForm');

    function updateSummary() {
        const qty = parseInt(qtyInput.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        const total = qty * price;
        const selectedTaxRate = taxRateSelect.value;
        
        // Get the rate from the selected option
        let taxRate = 0;
        const selectedOption = taxRateSelect.options[taxRateSelect.selectedIndex];
        if (selectedOption && selectedOption.value) {
            taxRate = parseFloat(selectedOption.dataset.rate) || 0;
        }
        
        const vat = total * (taxRate / 100);
        const totalWithVatValue = total + vat;

        if (qty > 0 && price > 0) {
            summary.style.display = 'block';
            totalCost.textContent = total.toLocaleString('fr-FR') + ' FCFA';
            
            if (taxRate > 0) {
                vatRow.style.display = 'flex';
                totalWithVatRow.style.display = 'flex';
                vatAmount.textContent = vat.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' FCFA';
                totalWithVat.textContent = totalWithVatValue.toLocaleString('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' FCFA';
            } else {
                vatRow.style.display = 'none';
                totalWithVatRow.style.display = 'none';
            }
        } else {
            summary.style.display = 'none';
        }
    }

    qtyInput.addEventListener('input', updateSummary);
    priceInput.addEventListener('input', updateSummary);
    taxRateSelect.addEventListener('change', updateSummary);
    updateSummary();

    // Gérer l'affichage du champ TVA selon le produit sélectionné
    const productSelect = document.getElementById('id_product');
    function updateTaxRateVisibility() {
        const hasVatMap = JSON.parse(productSelect.dataset.hasVatMap || '{}');
        const selectedId = productSelect.value;
        const hasVat = hasVatMap[selectedId] || false;
        if (hasVat) {
            taxRateGroup.style.display = 'block';
        } else {
            taxRateGroup.style.display = 'none';
            taxRateSelect.value = '';  // Réinitialiser si masqué
        }
    }
    productSelect.addEventListener('change', updateTaxRateVisibility);
    updateTaxRateVisibility();  // Initialiser au chargement

    // Intercepter la soumission du formulaire
    supplyForm.addEventListener('submit', function(e) {
        e.preventDefault();

        // Créer FormData à partir du formulaire
        const formData = new FormData(supplyForm);

        // Envoyer une requête AJAX
        fetch(supplyForm.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Afficher un message de succès
                const totalPrice = parseFloat(data.total_price);
                const vatAmountValue = parseFloat(data.vat_amount || 0);
                const expenseTypeId = data.expense_type_id;
                const amount = totalPrice.toFixed(2);

                // Check if we should auto-create expense
                if (expenseTypeId) {
                    // Automatically create the expense
                    const expenseData = new FormData();
                    expenseData.append('expense_type', expenseTypeId);
                    expenseData.append('amount', (totalPrice + vatAmountValue).toFixed(2));
                    expenseData.append('description', `Dépense liée à l'approvisionnement de ${data.product_name} (${data.quantity} x ${data.unit_price}FCFA)`);
                    expenseData.append('payment_method', data.payment_method || 'CASH');
                    expenseData.append('csrfmiddlewaretoken', formData.get('csrfmiddlewaretoken'));

                    fetch("{% url 'add_expense_ajax' %}", {
                        method: 'POST',
                        body: expenseData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        }
                    })
                    .then(expResponse => expResponse.json())
                    .then(expData => {
                        let message = data.message;
                        if (expData.success) {
                            message += '<br><small>La dépense a été créée automatiquement.</small>';
                        } else {
                            message += '<br><small>Attention: La dépense automatique n\'a pas pu être créée.</small>';
                        }
                        
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'alert alert-success';
                        messageDiv.style.marginBottom = '20px';
                        messageDiv.innerHTML = `<strong>✓ Succès!</strong> ${message}`;

                        const messagesContainer = document.querySelector('.messages-container') || document.querySelector('.card-body');
                        if (messagesContainer) {
                            messagesContainer.insertBefore(messageDiv, messagesContainer.firstChild);
                        }

                        // Réinitialiser le formulaire
                        supplyForm.reset();
                        summary.style.display = 'none';

                        // Rediriger vers la liste des approvisionnements après un court délai
                        setTimeout(() => {
                            window.location.href = "{% url 'supplies' %}";
                        }, 1500);
                    })
                    .catch(expError => {
                        console.error('Erreur création dépense:', expError);
                        // Continue anyway, show success message
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'alert alert-success';
                        messageDiv.style.marginBottom = '20px';
                        messageDiv.innerHTML = `<strong>✓ Succès!</strong> ${data.message}<br><small>La création automatique de la dépense a échoué. Vous pouvez la créer manuellement.</small>`;

                        const messagesContainer = document.querySelector('.messages-container') || document.querySelector('.card-body');
                        if (messagesContainer) {
                            messagesContainer.insertBefore(messageDiv, messagesContainer.firstChild);
                        }

                        supplyForm.reset();
                        summary.style.display = 'none';

                        setTimeout(() => {
                            window.location.href = "{% url 'supplies' %}";
                        }, 1500);
                    });
                } else {
                    // Old behavior: redirect to expense page
                    const expenseUrl = new URL("{% url 'add_expense' %}", window.location.origin);
                    expenseUrl.searchParams.append('amount', amount);
                    expenseUrl.searchParams.append('description', `Dépense liée à l'approvisionnement de ${data.product_name} (${data.quantity} x ${data.unit_price}FCFA)`);
                    expenseUrl.searchParams.append('expense_type', 'approvisionnement');

                    window.open(expenseUrl.toString(), '_blank');

                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'alert alert-success';
                    messageDiv.style.marginBottom = '20px';
                    messageDiv.innerHTML = `
                        <strong>✓ Succès!</strong> ${data.message}<br>
                        <small>La page d'ajout de dépenses a été ouverte dans un nouvel onglet.</small>
                    `;

                    const messagesContainer = document.querySelector('.messages-container') || document.querySelector('.card-body');
                    if (messagesContainer) {
                        messagesContainer.insertBefore(messageDiv, messagesContainer.firstChild);
                    }

                    supplyForm.reset();
                    summary.style.display = 'none';

                    setTimeout(() => {
                        window.location.href = "{% url 'supplies' %}";
                    }, 1500);
                }
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue lors de l\'enregistrement.');
        });
    });
});
</script>
{% endblock %}
